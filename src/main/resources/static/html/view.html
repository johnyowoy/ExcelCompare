<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看已上傳檔案</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .view-container {
            max-width: 800px;
            margin: 0 auto;
        }
        #status {
            display: none;
        }
        .modal-body {
            max-height: 500px;
            overflow-y: auto;
        }
        @media (max-width: 576px) {
            .view-container {
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/index.html">Excel 比較工具</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/index.html">首頁</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/html/compare.html">比較</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/html/view.html">查看檔案</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-4 view-container">
    <h1 class="mb-4">已上傳的檔案</h1>
    <div id="status" class="alert mt-3" role="alert"></div>
    <table class="table table-striped">
        <thead>
        <tr>
            <th scope="col">檔案名稱</th>
            <th scope="col">操作</th>
        </tr>
        </thead>
        <tbody id="fileList">
        <!-- 檔案清單將動態填充 -->
        </tbody>
    </table>
</div>

<!-- 模態框：顯示 Excel 內容 -->
<div class="modal fade" id="excelModal" tabindex="-1" aria-labelledby="excelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="excelModalLabel">Excel 內容</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead id="excelHeader"></thead>
                    <tbody id="excelBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const statusDiv = document.getElementById('status');
    const fileList = document.getElementById('fileList');
    const excelModal = new bootstrap.Modal(document.getElementById('excelModal'));
    const excelHeader = document.getElementById('excelHeader');
    const excelBody = document.getElementById('excelBody');
    const excelModalLabel = document.getElementById('excelModalLabel');

    async function loadFiles() {
        try {
            const response = await fetch('/api/files', { method: 'GET' });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `無法獲取檔案清單：${response.status}`);
            }

            if (result.files.length === 0) {
                statusDiv.innerText = '尚未上傳任何檔案';
                statusDiv.className = 'alert alert-info';
                statusDiv.style.display = 'block';
                fileList.innerHTML = '';
                return;
            }

            statusDiv.style.display = 'none';
            fileList.innerHTML = '';
            result.files.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.filename}</td>
                    <td>
                        <a href="/api/download/${file.fileId}" class="btn btn-primary btn-sm me-1">下載</a>
                        <button class="btn btn-info btn-sm me-1" onclick="viewExcelContent('${file.fileId}', '${file.filename}')">瀏覽 Excel 內容</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.fileId}')">移除檔案</button>
                    </td>
                `;
                fileList.appendChild(row);
            });
        } catch (error) {
            statusDiv.innerText = `❌ 無法載入檔案清單：${error.message}`;
            statusDiv.className = 'alert alert-danger';
            statusDiv.style.display = 'block';
            console.error('載入檔案錯誤：', error);
        }
    }

    async function viewExcelContent(fileId, filename) {
        try {
            const response = await fetch(`/api/file/${fileId}/content`, { method: 'GET' });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `無法獲取 Excel 內容：${response.status}`);
            }

            excelModalLabel.innerText = `Excel 內容 - ${filename}`;
            excelHeader.innerHTML = '';
            excelBody.innerHTML = '';

            // 渲染表頭
            const headerRow = document.createElement('tr');
            result.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';
                headerRow.appendChild(th);
            });
            excelHeader.appendChild(headerRow);

            // 渲染數據
            result.data.forEach(row => {
                const tr = document.createElement('tr');
                result.headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                excelBody.appendChild(tr);
            });

            excelModal.show();
        } catch (error) {
            statusDiv.innerText = `❌ 無法載入 Excel 內容：${error.message}`;
            statusDiv.className = 'alert alert-danger';
            statusDiv.style.display = 'block';
            console.error('載入 Excel 內容錯誤：', error);
        }
    }

    async function deleteFile(fileId) {
        if (!confirm('確定要移除此檔案嗎？')) return;

        try {
            const response = await fetch(`/api/file/${fileId}`, { method: 'DELETE' });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `無法移除檔案：${response.status}`);
            }

            statusDiv.innerText = '檔案已移除';
            statusDiv.className = 'alert alert-success';
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 3000);

            // 刷新檔案清單
            await loadFiles();
        } catch (error) {
            statusDiv.innerText = `❌ 無法移除檔案：${error.message}`;
            statusDiv.className = 'alert alert-danger';
            statusDiv.style.display = 'block';
            console.error('移除檔案錯誤：', error);
        }
    }

    // 頁面載入時獲取檔案清單
    window.addEventListener('load', loadFiles);
</script>
</body>
</html>